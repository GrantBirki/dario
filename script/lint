#! /usr/bin/env bash

set -euo pipefail

source script/env "$@"
source script/lib/hugo-fixture.sh

require_cmd hugo
require_cmd bash
require_cmd find
require_cmd mktemp

while IFS= read -r -d '' file; do
  bash -n "$file"
done < <(find "$DIR/script" -type f -print0)

if grep -nE '@media \((min|max)-inline-size:' "$DIR/assets/css/default.css" >/dev/null; then
  die "invalid media query feature in assets/css/default.css: use min-width/max-width for viewport queries"
fi

work_dir="$(mktemp -d "$TMP_DIR/hugo-lint-fixture.XXXXXX")"
site_dir="$work_dir/site"

cleanup() {
  rm -rf "$work_dir"
}
trap cleanup EXIT

create_hugo_fixture_site "$site_dir" "$DIR"

echo -e "${BLUE}Running Hugo lint checks${OFF}"
hugo \
  --source "$site_dir" \
  --renderToMemory \
  --panicOnWarning \
  --printPathWarnings \
  --printI18nWarnings

echo -e "${GREEN}Lint complete${OFF}"
