#! /usr/bin/env bash

set -euo pipefail

source script/env "$@"
source script/lib/hugo-fixture.sh

require_cmd hugo
require_cmd grep
require_cmd mktemp

work_dir="$(mktemp -d "$TMP_DIR/hugo-fixture.XXXXXX")"
site_dir="$work_dir/site"
output_dir="$work_dir/public"

cleanup() {
  rm -rf "$work_dir"
}
trap cleanup EXIT

create_hugo_fixture_site "$site_dir" "$DIR"

echo -e "${BLUE}Building fixture site${OFF}"
hugo \
  --source "$site_dir" \
  --destination "$output_dir" \
  --panicOnWarning \
  --printPathWarnings

home_html="$output_dir/index.html"
post_html="$output_dir/posts/first/index.html"
absolute_og_html="$output_dir/posts/absolute-og/index.html"
no_anchor_html="$output_dir/posts/no-anchors/index.html"
css_file="$(ls "$output_dir"/css/*.css | head -n1)"

[[ -f "$home_html" ]] || die "expected fixture homepage output at $home_html"
[[ -f "$post_html" ]] || die "expected fixture post output at $post_html"
[[ -f "$absolute_og_html" ]] || die "expected fixture absolute-og output at $absolute_og_html"
[[ -f "$no_anchor_html" ]] || die "expected fixture no-anchors output at $no_anchor_html"
[[ -f "$css_file" ]] || die "expected processed CSS output under $output_dir/css"

if ! grep -Fq "<h1>Home <em>Post</em></h1>" "$home_html"; then
  die "homepage title markdown did not render as expected"
fi

if grep -Fq "First *Post*" "$home_html"; then
  die "homepage post list title was not plainified as expected"
fi

if ! grep -Fq "First Post" "$home_html"; then
  die "homepage post list title text missing expected plainified value"
fi

if ! grep -Fq "<h1>First <em>Post</em></h1>" "$post_html"; then
  die "single post title markdown did not render as expected"
fi

if ! grep -Fq 'href="#details"' "$post_html"; then
  die "expected heading anchor link for rendered markdown heading"
fi

if grep -Fq 'href="#without-anchor"' "$no_anchor_html"; then
  die "disableAnchoredHeadings should disable heading anchor links"
fi

if ! grep -q "footnotes" "$post_html"; then
  die "single post with footnotes should include footnotes script"
fi

if grep -q "footnotes" "$home_html"; then
  die "homepage without footnotes should not include footnotes script"
fi

if ! grep -Fq "fonts/Newsreader.woff2" "$home_html"; then
  die "expected preload for primary Newsreader font on homepage"
fi

if grep -Fq "fonts/Newsreader-italic.woff2" "$home_html"; then
  die "homepage should not preload italic Newsreader font by default"
fi

if grep -Fq "/default.png" "$home_html"; then
  die "homepage still references missing default OG image fallback"
fi

if grep -Fq "https://example.org/blog/blog/" "$post_html"; then
  die "OG URLs should not duplicate base path segments"
fi

if ! grep -Fq '<meta property="og:url" content="https://example.org/blog/posts/first/">' "$post_html"; then
  die "single post should have a canonical og:url based on .Permalink"
fi

if ! grep -Eq '<meta property="og:image" content="https://example.org/blog/og/og-image-[^"]+\.svg">' "$post_html"; then
  die "single post should reference generated OG image with a correct absolute URL"
fi

if ! grep -Fq '<meta property="og:image" content="https://cdn.example.com/og.png">' "$absolute_og_html"; then
  die "absolute ogImage URL should be passed through without baseURL concatenation"
fi

if ! grep -Fq "url(../fonts/Newsreader.woff2)" "$css_file"; then
  die "CSS should reference Newsreader regular font via relative URL"
fi

if ! grep -Fq "url(../fonts/Newsreader-italic.woff2)" "$css_file"; then
  die "CSS should reference Newsreader italic font via relative URL"
fi

if grep -Fq "url(/fonts/" "$css_file"; then
  die "CSS should not use root-absolute font URLs"
fi

if ! grep -Fq "../fonts/Newsreader.woff2" "$output_dir"/og/*.svg; then
  die "generated OG SVG should use a relative font URL"
fi

if grep -q "A & B" "$output_dir"/og/*.svg; then
  die "OG SVG contains unescaped ampersand in description"
fi

if ! grep -q "A &amp; B" "$output_dir"/og/*.svg; then
  die "OG SVG is missing escaped description content"
fi

echo -e "${GREEN}Fixture tests passed${OFF}"
