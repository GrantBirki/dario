#! /usr/bin/env bash

set -euo pipefail

source script/env "$@"

HUGO_VERSION_FILE="$DIR/.github/.hugo-version"
HUGO_VENDOR_BIN_DIR="$DIR/.github/vendor/bin"

read_hugo_version() {
  [[ -f "$HUGO_VERSION_FILE" ]] || die "missing Hugo version file: $HUGO_VERSION_FILE"
  local version
  version="$(tr -d '[:space:]' < "$HUGO_VERSION_FILE")"
  [[ -n "$version" ]] || die "Hugo version file is empty: $HUGO_VERSION_FILE"
  printf '%s' "$version"
}

normalize_semver() {
  local version="$1"
  version="${version#v}"
  version="${version%%+*}"
  version="${version%%-*}"
  printf '%s' "$version"
}

hugo_installed_semver() {
  if ! command -v hugo >/dev/null 2>&1; then
    return 1
  fi
  normalize_semver "$(hugo version | awk '{print $2}')"
}

install_vendored_hugo_linux() {
  require_cmd dpkg

  local version="$1"
  local deb_pkg="$HUGO_VENDOR_BIN_DIR/hugo_extended_${version}_linux-amd64.deb"
  [[ -f "$deb_pkg" ]] || die "missing vendored Hugo package: $deb_pkg"

  echo -e "${BLUE}Installing vendored Hugo package:${OFF} ${PURPLE}${deb_pkg}${OFF}"
  as_root dpkg -i "$deb_pkg"
}

install_vendored_hugo_macos() {
  require_cmd installer

  local version="$1"
  local pkg="$HUGO_VENDOR_BIN_DIR/hugo_extended_${version}_darwin-universal.pkg"
  [[ -f "$pkg" ]] || die "missing vendored Hugo package: $pkg"

  echo -e "${BLUE}Installing vendored Hugo package:${OFF} ${PURPLE}${pkg}${OFF}"
  as_root installer -pkg "$pkg" -target /
}

install_hugo_default_linux() {
  if command -v apt-get >/dev/null 2>&1; then
    as_root apt-get update
    as_root env DEBIAN_FRONTEND=noninteractive apt-get install -y hugo
    return
  fi

  die "unable to install hugo automatically on linux (apt-get not found)"
}

install_hugo_default_macos() {
  require_cmd brew
  brew install hugo
}

install_hugo_for_ci() {
  local expected_version expected_semver installed_semver
  expected_version="$(read_hugo_version)"
  expected_semver="$(normalize_semver "$expected_version")"
  installed_semver="$(hugo_installed_semver || true)"
  echo -e "${BLUE}Installing vendored Hugo version:${OFF} ${PURPLE}${expected_semver}${OFF}"
  if [[ -n "$installed_semver" ]]; then
    echo -e "${BLUE}Detected preinstalled Hugo:${OFF} ${PURPLE}${installed_semver}${OFF}"
  fi

  case "$OSTYPE" in
    linux-gnu*)
      install_vendored_hugo_linux "$expected_version"
      ;;
    darwin*)
      install_vendored_hugo_macos "$expected_version"
      ;;
    *)
      die "unsupported OS for CI Hugo install: $OSTYPE"
      ;;
  esac

  installed_semver="$(hugo_installed_semver || true)"
  [[ "$installed_semver" == "$expected_semver" ]] || die "expected Hugo ${expected_semver}, but found ${installed_semver:-<missing>}"
  echo -e "${GREEN}Hugo version:${OFF} $(hugo version)"
}

install_hugo_default() {
  if command -v hugo >/dev/null 2>&1; then
    echo -e "${GREEN}Hugo version:${OFF} $(hugo version)"
    return
  fi

  warn "hugo not found; installing..."
  case "$OSTYPE" in
    linux-gnu*)
      install_hugo_default_linux
      ;;
    darwin*)
      install_hugo_default_macos
      ;;
    *)
      die "unsupported OS for automatic hugo install: $OSTYPE"
      ;;
  esac

  require_cmd hugo
  echo -e "${GREEN}Hugo version:${OFF} $(hugo version)"
}

if [[ "${CI:-}" == "true" ]]; then
  install_hugo_for_ci
else
  install_hugo_default
fi
